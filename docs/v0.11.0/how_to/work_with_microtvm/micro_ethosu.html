





<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Running TVM on bare metal Arm(R) Cortex(R)-M55 CPU and Ethos(TM)-U55 NPU with CMSIS-NN &mdash; tvm 0.11.dev0 documentation</title>
  

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/sg_gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/sg_gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/sg_gallery-dataframe.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/sg_gallery-rendered-html.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/tlcpack_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/tvm-logo-square.png"/>
  

  
  
  
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <script type="text/javascript" src="../../_static/js/tlcpack_theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="microTVM PyTorch Tutorial" href="micro_pytorch.html" />
    <link rel="prev" title="Autotuning with microTVM" href="micro_autotune.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    
<header class="header">
    <div class="innercontainer">
      <div class="headerInner d-flex justify-content-between align-items-center">
          <div class="headerLogo">
               <a href="https://tvm.apache.org/"><img src=https://tvm.apache.org/assets/images/logo.svg alt="logo"></a>
          </div>

          <div id="headMenu" class="headerNav">
            <button type="button" id="closeHeadMenu" class="navCloseBtn"><img src="../../_static/img/close-icon.svg" alt="Close"></button>
             <ul class="nav">
                <li class="nav-item">
                   <a class="nav-link" href=https://tvm.apache.org/community>Community</a>
                </li>
                <li class="nav-item">
                   <a class="nav-link" href=https://tvm.apache.org/download>Download</a>
                </li>
                <li class="nav-item">
                   <a class="nav-link" href=https://tvm.apache.org/vta>VTA</a>
                </li>
                <li class="nav-item">
                   <a class="nav-link" href=https://tvm.apache.org/blog>Blog</a>
                </li>
                <li class="nav-item">
                   <a class="nav-link" href=https://tvm.apache.org/docs>Docs</a>
                </li>
                <li class="nav-item">
                   <a class="nav-link" href=https://tvmconf.org>Conference</a>
                </li>
                <li class="nav-item">
                   <a class="nav-link" href=https://github.com/apache/tvm/>Github</a>
                </li>
             </ul>
               <div class="responsivetlcdropdown">
                 <button type="button" class="btn-link">
                   ASF
                 </button>
                 <ul>
                     <li>
                       <a href=https://apache.org/>Apache Homepage</a>
                     </li>
                     <li>
                       <a href=https://www.apache.org/licenses/>License</a>
                     </li>
                     <li>
                       <a href=https://www.apache.org/foundation/sponsorship.html>Sponsorship</a>
                     </li>
                     <li>
                       <a href=https://www.apache.org/security/>Security</a>
                     </li>
                     <li>
                       <a href=https://www.apache.org/foundation/thanks.html>Thanks</a>
                     </li>
                     <li>
                       <a href=https://www.apache.org/events/current-event>Events</a>
                     </li>
                 </ul>
               </div>
          </div>
            <div class="responsiveMenuIcon">
              <button type="button" id="menuBtn" class="btn-menu"><img src="../../_static/img/menu-icon.svg" alt="Menu Icon"></button>
            </div>

            <div class="tlcDropdown">
              <div class="dropdown">
                <button type="button" class="btn-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  ASF
                </button>
                <div class="dropdown-menu dropdown-menu-right">
                  <ul>
                     <li>
                       <a href=https://apache.org/>Apache Homepage</a>
                     </li>
                     <li>
                       <a href=https://www.apache.org/licenses/>License</a>
                     </li>
                     <li>
                       <a href=https://www.apache.org/foundation/sponsorship.html>Sponsorship</a>
                     </li>
                     <li>
                       <a href=https://www.apache.org/security/>Security</a>
                     </li>
                     <li>
                       <a href=https://www.apache.org/foundation/thanks.html>Thanks</a>
                     </li>
                     <li>
                       <a href=https://www.apache.org/events/current-event>Events</a>
                     </li>
                  </ul>
                </div>
              </div>
          </div>
       </div>
    </div>
 </header>
 
    <nav data-toggle="wy-nav-shift" class="wy-nav-side fixed">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/tvm-logo-small.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <input type="checkbox" class="version-toggle-box" hidden id="version-toggle">
              <label for="version-toggle" class="version-toggle-label">
                  <div tabindex="0" class="version version-selector version-selector-show">
                    0.11.dev0 <span class="chevron versions-hidden"><svg fill="none" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="m8 4 8 8-8 8" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg></span><span class="chevron versions-shown"><svg fill="none" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="m4 8 8 8 8-8" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg></span>
                  </div>
                </label>
                <div class="version-details wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                  <p class="caption" role="heading"><span class="caption-text">Versions</span></p>
                  <ol style="text-align: left">
                    
                    
                    
                    
                      <li><div class="version"><a style="font-size: 0.8em; padding: 4px" href="/">0.11.dev0 (main)</a></div></li>
                    
                    
                    
                    
                      <li><div class="version"><a style="font-size: 0.8em; padding: 4px" href="v0.8.0/">v0.8.0</a></div></li>
                    
                    
                    
                    
                      <li><div class="version"><a style="font-size: 0.8em; padding: 4px" href="v0.9.0/">v0.9.0</a></div></li>
                    
                    
                    
                    
                      <li><div class="version"><a style="font-size: 0.8em; padding: 4px" href="v0.10.0/">v0.10.0</a></div></li>
                    
                  </ol>
                </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install/index.html">Installing TVM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute/index.html">Contributor Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/index.html">User Tutorial</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">How To Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../compile_models/index.html">Compile Deep Learning Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deploy/index.html">Deploy Models and Integrate TVM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../work_with_relay/index.html">Work With Relay</a></li>
<li class="toctree-l2"><a class="reference internal" href="../work_with_schedules/index.html">Work With Tensor Expression and Schedules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../optimize_operators/index.html">Optimize Tensor Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tune_with_autotvm/index.html">Auto-Tune with Templates and AutoTVM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tune_with_autoscheduler/index.html">Use AutoScheduler for Template-Free Scheduling</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Work With microTVM</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="micro_aot.html">microTVM Host-Driven AoT</a></li>
<li class="toctree-l3"><a class="reference internal" href="micro_autotune.html">Autotuning with microTVM</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Running TVM on bare metal Arm(R) Cortex(R)-M55 CPU and Ethos(TM)-U55 NPU with CMSIS-NN</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#obtaining-tvm">Obtaining TVM</a></li>
<li class="toctree-l4"><a class="reference internal" href="#installing-additional-python-dependencies">Installing additional python dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#obtaining-the-model">Obtaining the Model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compiling-the-model-for-arm-r-cortex-r-m55-cpu-and-ethos-tm-u55-npu-with-cmsis-nn">Compiling the model for Arm(R) Cortex(R)-M55 CPU and Ethos(TM)-U55 NPU with CMSIS-NN</a></li>
<li class="toctree-l4"><a class="reference internal" href="#extracting-the-generated-code-into-the-current-directory">Extracting the generated code into the current directory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#getting-imagenet-labels">Getting ImageNet labels</a></li>
<li class="toctree-l4"><a class="reference internal" href="#getting-the-input-image">Getting the input image</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pre-processing-the-image">Pre-processing the image</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pre-processing-the-labels">Pre-processing the labels</a></li>
<li class="toctree-l4"><a class="reference internal" href="#writing-the-demo-application">Writing the demo application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#creating-the-linker-script">Creating the linker script</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-the-demo-application-using-make">Building the demo application using make</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-the-demo-application">Running the demo application</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="micro_pytorch.html">microTVM PyTorch Tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="micro_reference_vm.html">microTVM Reference Virtual Machines</a></li>
<li class="toctree-l3"><a class="reference internal" href="micro_tflite.html">microTVM with TFLite Models</a></li>
<li class="toctree-l3"><a class="reference internal" href="micro_train.html">Training Vision Models for microTVM on Arduino</a></li>
<li class="toctree-l3"><a class="reference internal" href="micro_tvmc.html">Executing a Tiny Model with TVMC Micro</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../extend_tvm/index.html">Extend TVM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../profile/index.html">Profile Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../errors.html">Handle TVM Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq.html">Frequently Asked Questions</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../dev/tutorial/index.html">Developer Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/how_to/how_to.html">Developer How-To Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Architecture  Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arch/index.html">Design and Architecture</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Topic Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../topic/microtvm/index.html">microTVM: TVM on bare-metal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../topic/vta/index.html">VTA: Versatile Tensor Accelerator</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../reference/langref/index.html">Language Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/api/python/index.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/api/links.html">Other APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Index</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      
      <nav class="wy-nav-top" aria-label="top navigation" data-toggle="wy-nav-top">
        
            <div class="togglemenu">

            </div>
            <div class="nav-content">
              <!-- tvm -->
              Table of Contents
            </div>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        

          




















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> <span class="br-arrow">></span></li>
        
          <li><a href="../index.html">How To Guides</a> <span class="br-arrow">></span></li>
        
          <li><a href="index.html">Work With microTVM</a> <span class="br-arrow">></span></li>
        
      <li>Running TVM on bare metal Arm(R) Cortex(R)-M55 CPU and Ethos(TM)-U55 NPU with CMSIS-NN</li>
    
    
      
      
        
      
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/apache/tvm/edit/main/docs/how_to/work_with_microtvm/micro_ethosu.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-how-to-work-with-microtvm-micro-ethosu-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<div class="sphx-glr-example-title section" id="running-tvm-on-bare-metal-arm-r-cortex-r-m55-cpu-and-ethos-tm-u55-npu-with-cmsis-nn">
<span id="sphx-glr-how-to-work-with-microtvm-micro-ethosu-py"></span><h1>Running TVM on bare metal Arm(R) Cortex(R)-M55 CPU and Ethos(TM)-U55 NPU with CMSIS-NN<a class="headerlink" href="#running-tvm-on-bare-metal-arm-r-cortex-r-m55-cpu-and-ethos-tm-u55-npu-with-cmsis-nn" title="Permalink to this headline">¶</a></h1>
<p><strong>Author</strong>:
<a class="reference external" href="https://github.com/grant-arm">Grant Watson</a></p>
<p>This section contains an example of how to use TVM to run a model
on an Arm(R) Cortex(R)-M55 CPU and Ethos(TM)-U55 NPU with CMSIS-NN, using bare metal.
The Cortex(R)-M55 is a small, low-power CPU designed for use in embedded
devices. CMSIS-NN is a collection of kernels optimized for Arm(R) Cortex(R)-M CPUs.
The Ethos(TM)-U55 is a microNPU, specifically designed to accelerate
ML inference in resource-constrained embedded devices.</p>
<p>In order to run the demo application without having access to a Cortex(R)-M55
and Ethos(TM)-U55 development board, we will be running our sample application
on a Fixed Virtual Platform (FVP). The FVP based on Arm(R) Corstone(TM)-300
software, models a hardware system containing a Cortex(R)-M55 and Ethos(TM)-U55.
It provides a programmer’s view that is suitable for software development.</p>
<p>In this tutorial, we will be compiling a MobileNet v1 model and instructing
TVM to offload operators to the Ethos(TM)-U55 where possible.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="section" id="obtaining-tvm">
<h2>Obtaining TVM<a class="headerlink" href="#obtaining-tvm" title="Permalink to this headline">¶</a></h2>
<p>To obtain TVM for you platform, please visit <a class="reference external" href="https://tlcpack.ai/">https://tlcpack.ai/</a> and follow the
instructions. Once TVM has been installed correctly, you should have access to
<code class="docutils literal notranslate"><span class="pre">tvmc</span></code> from the command line.</p>
<p>Typing <code class="docutils literal notranslate"><span class="pre">tvmc</span></code> on the command line should display the following:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>usage: tvmc [-h] [-v] [--version] {tune,compile,run} ...

TVM compiler driver

optional arguments:
  -h, --help          show this help message and exit
  -v, --verbose       increase verbosity
  --version           print the version and exit

commands:
  {tune,compile,run}
    tune              auto-tune a model
    compile           compile a model.
    run               run a compiled module

TVMC - TVM driver command-line interface
</pre></div>
</div>
</div>
<div class="section" id="installing-additional-python-dependencies">
<h2>Installing additional python dependencies<a class="headerlink" href="#installing-additional-python-dependencies" title="Permalink to this headline">¶</a></h2>
<p>In order to run the demo, you will need some additional python packages.
These can be installed by using the requirements.txt file below:</p>
<div class="literal-block-wrapper docutils container" id="requirements-txt">
<div class="code-block-caption"><span class="caption-text">requirements.txt</span><a class="headerlink" href="#requirements-txt" title="Permalink to this code">¶</a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> attrs==21.2.0
 cloudpickle==2.0.0
 decorator==5.1.0
 ethos-u-vela==3.5.0
 flatbuffers==1.12
 lxml==4.6.3
 nose==1.3.7
 numpy==1.19.5
 Pillow==8.3.2
 psutil==5.8.0
 scipy==1.5.4
 synr==0.6
 tflite==2.4.0
 tornado==6.1
</pre></div>
</div>
</div>
<p>These packages can be installed by running the following from the command line:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip install -r requirements.txt
</pre></div>
</div>
</div>
<div class="section" id="obtaining-the-model">
<h2>Obtaining the Model<a class="headerlink" href="#obtaining-the-model" title="Permalink to this headline">¶</a></h2>
<p>For this tutorial, we will be working with MobileNet v1.
MobileNet v1 is a convolutional neural network designed to classify images,
that has been optimized for edge devices. The model we will be using has been
pre-trained to classify images into one of 1001 different categories.
The network has an input image size of 224x224 so any input images will need
to be resized to those dimensions before being used.</p>
<p>For this tutorial we will be using the model in Tflite format.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir -p ./build
<span class="nb">cd</span> build
wget https://storage.googleapis.com/download.tensorflow.org/models/mobilenet_v1_2018_08_02/mobilenet_v1_1.0_224_quant.tgz
gunzip mobilenet_v1_1.0_224_quant.tgz
tar xvf mobilenet_v1_1.0_224_quant.tar
</pre></div>
</div>
</div>
<div class="section" id="compiling-the-model-for-arm-r-cortex-r-m55-cpu-and-ethos-tm-u55-npu-with-cmsis-nn">
<h2>Compiling the model for Arm(R) Cortex(R)-M55 CPU and Ethos(TM)-U55 NPU with CMSIS-NN<a class="headerlink" href="#compiling-the-model-for-arm-r-cortex-r-m55-cpu-and-ethos-tm-u55-npu-with-cmsis-nn" title="Permalink to this headline">¶</a></h2>
<p>Once we’ve downloaded the MobileNet v1 model, the next step is to compile it.
To accomplish that, we are going to use <code class="docutils literal notranslate"><span class="pre">tvmc</span> <span class="pre">compile</span></code>. The output we get from
the compilation process is a TAR package of the model compiled to the Model
Library Format (MLF) for our target platform. We will be able to run that model
on our target device using the TVM runtime.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tvmc compile --target<span class="o">=</span>ethos-u,cmsis-nn,c <span class="se">\</span>
             --target-ethos-u-accelerator_config<span class="o">=</span>ethos-u55-256 <span class="se">\</span>
             --target-cmsis-nn-mcpu<span class="o">=</span>cortex-m55 <span class="se">\</span>
             --target-c-mcpu<span class="o">=</span>cortex-m55 <span class="se">\</span>
             --runtime<span class="o">=</span>crt <span class="se">\</span>
             --executor<span class="o">=</span>aot <span class="se">\</span>
             --executor-aot-interface-api<span class="o">=</span>c <span class="se">\</span>
             --executor-aot-unpacked-api<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
             --pass-config tir.usmp.enable<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
             --pass-config tir.usmp.algorithm<span class="o">=</span>hill_climb <span class="se">\</span>
             --pass-config tir.disable_storage_rewrite<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
             --pass-config tir.disable_vectorize<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
             ./mobilenet_v1_1.0_224_quant.tflite <span class="se">\</span>
             --output-format<span class="o">=</span>mlf
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Explanation of tvmc compile arguments:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--target=ethos-u,cmsis-nn,c</span></code> : offload operators to the microNPU where possible, falling back to CMSIS-NN and finally generated C code where an operator is not supported on the microNPU..</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--target-ethos-u-accelerator_config=ethos-u55-256</span></code> : specifies the microNPU configuration</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--target-c-mcpu=cortex-m55</span></code> : Cross-compile for the Cortex(R)-M55.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--runtime=crt</span></code> : Generate glue code to allow operators to work with C runtime.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--executor=aot</span></code> : Use Ahead Of Time compiltaion instead of the Graph Executor.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--executor-aot-interface-api=c</span></code> : Generate a C-style interface with structures designed for integrating into C apps at the boundary.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--executor-aot-unpacked-api=1</span></code> : Use the unpacked API internally.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--pass-config</span> <span class="pre">tir.usmp.enable=1</span></code> : Enable Unified Static Memory Planning</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--pass-config</span> <span class="pre">tir.usmp.algorithm=hill_climb</span></code> : Use the hill-climb algorithm for USMP</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--pass-config</span> <span class="pre">tir.disable_storage_rewrite=1</span></code> : Disable storage rewrite</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--pass-config</span> <span class="pre">tir.disable_vectorize=1</span></code> : Disable vectorize since there are no standard vectorized types in C.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">./mobilenet_v1_1.0_224_quant.tflite</span></code> : The TFLite model that is being compiled.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--output-format=mlf</span></code> : Output should be generated in the Model Library Format.</p></li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<dl class="simple">
<dt>If you don’t want to make use of the microNPU and want to offload</dt><dd><p>operators to CMSIS-NN only:</p>
</dd>
</dl>
<ul class="simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">--target=cmsis-nn,c</span></code> in place of <code class="docutils literal notranslate"><span class="pre">--target=ethos-u,cmsis-nn,c</span></code></p></li>
<li><p>Remove the microNPU config parameter <code class="docutils literal notranslate"><span class="pre">--target-ethos-u-accelerator_config=ethos-u55-256</span></code></p></li>
</ul>
</div>
</div>
<div class="section" id="extracting-the-generated-code-into-the-current-directory">
<h2>Extracting the generated code into the current directory<a class="headerlink" href="#extracting-the-generated-code-into-the-current-directory" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tar xvf module.tar
</pre></div>
</div>
</div>
<div class="section" id="getting-imagenet-labels">
<h2>Getting ImageNet labels<a class="headerlink" href="#getting-imagenet-labels" title="Permalink to this headline">¶</a></h2>
<p>When running MobileNet v1 on an image, the result is an index in the range 0 to
1000. In order to make our application a little more user friendly, instead of
just displaying the category index, we will display the associated label. We
will download these image labels into a text file now and use a python script
to include them in our C application later.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl -sS  https://raw.githubusercontent.com/tensorflow/tensorflow/master/tensorflow/lite/java/demo/app/src/main/assets/labels_mobilenet_quant_v1_224.txt <span class="se">\</span>
-o ./labels_mobilenet_quant_v1_224.txt
</pre></div>
</div>
</div>
<div class="section" id="getting-the-input-image">
<h2>Getting the input image<a class="headerlink" href="#getting-the-input-image" title="Permalink to this headline">¶</a></h2>
<p>As input for this tutorial, we will use the image of a cat, but you can
substitute an image of your choosing.</p>
<a class="reference internal image-reference" href="https://s3.amazonaws.com/model-server/inputs/kitten.jpg"><img alt="https://s3.amazonaws.com/model-server/inputs/kitten.jpg" class="align-center" src="https://s3.amazonaws.com/model-server/inputs/kitten.jpg" style="width: 224px; height: 224px;" /></a>
<p>We download the image into the build directory and we will use a python script
in the next step to convert the image into an array of bytes in a C header file.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl -sS https://s3.amazonaws.com/model-server/inputs/kitten.jpg -o ./kitten.jpg
</pre></div>
</div>
</div>
<div class="section" id="pre-processing-the-image">
<h2>Pre-processing the image<a class="headerlink" href="#pre-processing-the-image" title="Permalink to this headline">¶</a></h2>
<p>The following script will create 2 C header files in the src directory:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">inputs.h</span></code> - The image supplied as an argument to the script will be converted
to an array of integers for input to our MobileNet v1 model.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">outputs.h</span></code> - An integer array of zeroes will reserve 1001 integer values
for the output of inference.</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="convert-image-py">
<div class="code-block-caption"><span class="caption-text">convert_image.py</span><a class="headerlink" href="#convert-image-py" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="c1">#!python ./convert_image.py</span>
 <span class="kn">import</span> <span class="nn">os</span>
 <span class="kn">import</span> <span class="nn">pathlib</span>
 <span class="kn">import</span> <span class="nn">re</span>
 <span class="kn">import</span> <span class="nn">sys</span>
 <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
 <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


 <span class="k">def</span> <span class="nf">create_header_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">tensor_name</span><span class="p">,</span> <span class="n">tensor_data</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>
     <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     This function generates a header file containing the data from the numpy array provided.</span>
<span class="sd">     &quot;&quot;&quot;</span>
     <span class="n">file_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">/&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
     <span class="c1"># Create header file with npy_data as a C array</span>
     <span class="n">raw_path</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.h&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
     <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">raw_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">header_file</span><span class="p">:</span>
         <span class="n">header_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
             <span class="s2">&quot;#include &lt;tvmgen_default.h&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
             <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;const size_t </span><span class="si">{</span><span class="n">tensor_name</span><span class="si">}</span><span class="s2">_len = </span><span class="si">{</span><span class="n">tensor_data</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&quot;</span>
             <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;uint8_t </span><span class="si">{</span><span class="n">tensor_name</span><span class="si">}</span><span class="s1">[] __attribute__((section(&quot;</span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s1">&quot;), aligned(16))) = &quot;&#39;</span>
         <span class="p">)</span>
         <span class="n">data_hexstr</span> <span class="o">=</span> <span class="n">tensor_data</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_hexstr</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
             <span class="n">header_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">x</span><span class="si">{</span><span class="n">data_hexstr</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
         <span class="n">header_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&quot;;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>


 <span class="k">def</span> <span class="nf">create_headers</span><span class="p">(</span><span class="n">image_name</span><span class="p">):</span>
     <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     This function generates C header files for the input and output arrays required to run inferences</span>
<span class="sd">     &quot;&quot;&quot;</span>
     <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;./&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">image_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

     <span class="c1"># Resize image to 224x224</span>
     <span class="n">resized_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">))</span>
     <span class="n">img_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">resized_image</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>

     <span class="c1"># Convert input to NCHW</span>
     <span class="n">img_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">img_data</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

     <span class="c1"># Create input header file</span>
     <span class="n">input_data</span> <span class="o">=</span> <span class="n">img_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
     <span class="n">create_header_file</span><span class="p">(</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="s2">&quot;ethosu_scratch&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="s2">&quot;./include&quot;</span><span class="p">)</span>
     <span class="c1"># Create output header file</span>
     <span class="n">output_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1001</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
     <span class="n">create_header_file</span><span class="p">(</span>
         <span class="s2">&quot;outputs&quot;</span><span class="p">,</span>
         <span class="s2">&quot;output_data_sec&quot;</span><span class="p">,</span>
         <span class="s2">&quot;output&quot;</span><span class="p">,</span>
         <span class="n">output_data</span><span class="p">,</span>
         <span class="s2">&quot;./include&quot;</span><span class="p">,</span>
     <span class="p">)</span>


 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
     <span class="n">create_headers</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>Run the script from the command line:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python convert_image.py ./kitten.jpg
</pre></div>
</div>
</div>
<div class="section" id="pre-processing-the-labels">
<h2>Pre-processing the labels<a class="headerlink" href="#pre-processing-the-labels" title="Permalink to this headline">¶</a></h2>
<p>The following script will create a <code class="docutils literal notranslate"><span class="pre">labels.h</span></code> header file in the src directory.
The labels.txt file that we downloaded previously will be turned
into an array of strings. This array will be used to display the label that
our image has been classified as.</p>
<div class="literal-block-wrapper docutils container" id="convert-labels-py">
<div class="code-block-caption"><span class="caption-text">convert_labels.py</span><a class="headerlink" href="#convert-labels-py" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="c1">#!python ./convert_labels.py</span>
 <span class="kn">import</span> <span class="nn">os</span>
 <span class="kn">import</span> <span class="nn">pathlib</span>
 <span class="kn">import</span> <span class="nn">sys</span>


 <span class="k">def</span> <span class="nf">create_labels_header</span><span class="p">(</span><span class="n">labels_file</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>
     <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     This function generates a header file containing the ImageNet labels as an array of strings</span>
<span class="sd">     &quot;&quot;&quot;</span>
     <span class="n">labels_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">labels_file</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
     <span class="n">file_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">/labels.h&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

     <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">labels_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
         <span class="n">labels</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

     <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">header_file</span><span class="p">:</span>
         <span class="n">header_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;char* labels[] __attribute__((section(&quot;</span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s1">&quot;), aligned(16))) = </span><span class="se">{{</span><span class="s1">&#39;</span><span class="p">)</span>

         <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
             <span class="n">header_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">label</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="si">}</span><span class="s1">&quot;,&#39;</span><span class="p">)</span>

         <span class="n">header_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;};</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
     <span class="n">create_labels_header</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;ethosu_scratch&quot;</span><span class="p">,</span> <span class="s2">&quot;./include&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Run the script from the command line:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python convert_labels.py
</pre></div>
</div>
</div>
<div class="section" id="writing-the-demo-application">
<h2>Writing the demo application<a class="headerlink" href="#writing-the-demo-application" title="Permalink to this headline">¶</a></h2>
<p>The following C application will run a single inference of the MobileNet v1
model on the image that we downloaded and converted to an array of integers
previously. Since the model was compiled with a target of “ethos-u …”,
operators supported by the Ethos(TM)-U55 NPU will be offloaded for acceleration.
Once the application is built and run, our test image should be correctly
classied as a “tabby” and the result should be displayed on the console.
This file should be placed in <code class="docutils literal notranslate"><span class="pre">./src</span></code></p>
<div class="literal-block-wrapper docutils container" id="demo-c">
<div class="code-block-caption"><span class="caption-text">demo.c</span><a class="headerlink" href="#demo-c" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="w"> </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;tvm_runtime.h&gt;</span><span class="cp"></span>

<span class="w"> </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ethosu_mod.h&quot;</span><span class="cp"></span>
<span class="w"> </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;uart.h&quot;</span><span class="cp"></span>

<span class="w"> </span><span class="c1">// Header files generated by convert_image.py and convert_labels.py</span>
<span class="w"> </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;inputs.h&quot;</span><span class="cp"></span>
<span class="w"> </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;labels.h&quot;</span><span class="cp"></span>
<span class="w"> </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;outputs.h&quot;</span><span class="cp"></span>

<span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">abs</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">v</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">uart_init</span><span class="p">();</span><span class="w"></span>
<span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Starting Demo</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="n">EthosuInit</span><span class="p">();</span><span class="w"></span>

<span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Allocating memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="n">StackMemoryManager_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">app_workspace</span><span class="p">,</span><span class="w"> </span><span class="n">g_aot_memory</span><span class="p">,</span><span class="w"> </span><span class="n">WORKSPACE_SIZE</span><span class="p">);</span><span class="w"></span>

<span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Running inference</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="k">struct</span><span class="w"> </span><span class="nc">tvmgen_default_outputs</span><span class="w"> </span><span class="n">outputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="p">.</span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="p">};</span><span class="w"></span>
<span class="w">   </span><span class="k">struct</span><span class="w"> </span><span class="nc">tvmgen_default_inputs</span><span class="w"> </span><span class="n">inputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="p">.</span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="p">};</span><span class="w"></span>
<span class="w">   </span><span class="k">struct</span><span class="w"> </span><span class="nc">ethosu_driver</span><span class="o">*</span><span class="w"> </span><span class="n">driver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ethosu_reserve_driver</span><span class="p">();</span><span class="w"></span>
<span class="w">   </span><span class="k">struct</span><span class="w"> </span><span class="nc">tvmgen_default_devices</span><span class="w"> </span><span class="n">devices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="p">.</span><span class="n">ethos_u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">driver</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="p">};</span><span class="w"></span>
<span class="w">   </span><span class="n">tvmgen_default_run</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inputs</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">outputs</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">devices</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="n">ethosu_release_driver</span><span class="p">(</span><span class="n">driver</span><span class="p">);</span><span class="w"></span>

<span class="w">   </span><span class="c1">// Calculate index of max value</span>
<span class="w">   </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">max_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">max_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">output_len</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">max_value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="n">max_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">       </span><span class="n">max_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;The image has been classified as &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">labels</span><span class="p">[</span><span class="n">max_index</span><span class="p">]);</span><span class="w"></span>

<span class="w">   </span><span class="c1">// The FVP will shut down when it receives &quot;EXITTHESIM&quot; on the UART</span>
<span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;EXITTHESIM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>In addition, you will need these header files from github in your <code class="docutils literal notranslate"><span class="pre">./include</span></code> directory:</p>
<p><a class="reference external" href="https://github.com/apache/tvm/tree/main/apps/microtvm/ethosu/include">include files</a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you’d like to use FreeRTOS for task scheduling and queues, a sample application can be found here
<cite>demo_freertos.c &lt;https://github.com/apache/tvm/blob/main/apps/microtvm/ethosu/src/demo_freertos.c&gt;</cite></p>
</div>
</div>
<div class="section" id="creating-the-linker-script">
<h2>Creating the linker script<a class="headerlink" href="#creating-the-linker-script" title="Permalink to this headline">¶</a></h2>
<p>We need to create a linker script that will be used when we build our application
in the following section. The linker script tells the linker where everything
should be placed in memory. The corstone300.ld linker script below should be
placed in your working directory.</p>
<p>An example linker script for the FVP can be found here
<a class="reference external" href="https://github.com/apache/tvm/blob/main/apps/microtvm/ethosu/corstone300.ld">corstone300.ld</a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The code generated by TVM will place the model weights and the Arm(R)
Ethos(TM)-U55 command stream in a section named <code class="docutils literal notranslate"><span class="pre">ethosu_scratch</span></code>.
For a model the size of MobileNet v1, the weights and command stream will not
fit into the limited SRAM available. For this reason it’s important that the
linker script places the <code class="docutils literal notranslate"><span class="pre">ethosu_scratch</span></code> section into DRAM (DDR).</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Before building and running the application, you will need to update your
PATH environment variable to include the path to cmake 3.19.5 and the FVP.
For example if you’ve installed these in <code class="docutils literal notranslate"><span class="pre">/opt/arm</span></code> , then you would do
the following:</p>
<p><code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">PATH=/opt/arm/FVP_Corstone_SSE-300_Ethos-U55/models/Linux64_GCC-6.4:/opt/arm/cmake/bin:$PATH</span></code></p>
</div>
</div>
<div class="section" id="building-the-demo-application-using-make">
<h2>Building the demo application using make<a class="headerlink" href="#building-the-demo-application-using-make" title="Permalink to this headline">¶</a></h2>
<p>We can now build the demo application using make. The Makefile should be placed
in your working directory before running <code class="docutils literal notranslate"><span class="pre">make</span></code> on the command line:</p>
<p>An example Makefile can be found here:
<a class="reference external" href="https://github.com/apache/tvm/blob/main/apps/microtvm/ethosu/Makefile">Makefile</a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<dl class="simple">
<dt>If you’re using FreeRTOS, the Makefile builds it from the specified FREERTOS_PATH:</dt><dd><p><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">FREERTOS_PATH=&lt;FreeRTOS</span> <span class="pre">directory&gt;</span></code></p>
</dd>
</dl>
</div>
</div>
<div class="section" id="running-the-demo-application">
<h2>Running the demo application<a class="headerlink" href="#running-the-demo-application" title="Permalink to this headline">¶</a></h2>
<p>Finally, we can run our demo appliction on the Fixed Virtual Platform (FVP),
by using the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>FVP_Corstone_SSE-300_Ethos-U55 -C cpu0.CFGDTCMSZ<span class="o">=</span><span class="m">15</span> <span class="se">\</span>
-C cpu0.CFGITCMSZ<span class="o">=</span><span class="m">15</span> -C mps3_board.uart0.out_file<span class="o">=</span><span class="se">\&quot;</span>-<span class="se">\&quot;</span> -C mps3_board.uart0.shutdown_tag<span class="o">=</span><span class="se">\&quot;</span>EXITTHESIM<span class="se">\&quot;</span> <span class="se">\</span>
-C mps3_board.visualisation.disable-visualisation<span class="o">=</span><span class="m">1</span> -C mps3_board.telnetterminal0.start_telnet<span class="o">=</span><span class="m">0</span> <span class="se">\</span>
-C mps3_board.telnetterminal1.start_telnet<span class="o">=</span><span class="m">0</span> -C mps3_board.telnetterminal2.start_telnet<span class="o">=</span><span class="m">0</span> -C mps3_board.telnetterminal5.start_telnet<span class="o">=</span><span class="m">0</span> <span class="se">\</span>
-C ethosu.extra_args<span class="o">=</span><span class="s2">&quot;--fast&quot;</span> <span class="se">\</span>
-C ethosu.num_macs<span class="o">=</span><span class="m">256</span> ./build/demo
</pre></div>
</div>
<p>You should see the following output displayed in your console window:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>telnetterminal0: Listening for serial connection on port 5000
telnetterminal1: Listening for serial connection on port 5001
telnetterminal2: Listening for serial connection on port 5002
telnetterminal5: Listening for serial connection on port 5003

    Ethos-U rev dedfa618 --- Jan 12 2021 23:03:55
    (C) COPYRIGHT 2019-2021 Arm Limited
    ALL RIGHTS RESERVED

Starting Demo
ethosu_init. base_address=0x48102000, fast_memory=0x0, fast_memory_size=0, secure=1, privileged=1
ethosu_register_driver: New NPU driver at address 0x20000de8 is registered.
CMD=0x00000000
Soft reset NPU
Allocating memory
Running inference
ethosu_find_and_reserve_driver - Driver 0x20000de8 reserved.
ethosu_invoke
CMD=0x00000004
QCONFIG=0x00000002
REGIONCFG0=0x00000003
REGIONCFG1=0x00000003
REGIONCFG2=0x00000013
REGIONCFG3=0x00000053
REGIONCFG4=0x00000153
REGIONCFG5=0x00000553
REGIONCFG6=0x00001553
REGIONCFG7=0x00005553
AXI_LIMIT0=0x0f1f0000
AXI_LIMIT1=0x0f1f0000
AXI_LIMIT2=0x0f1f0000
AXI_LIMIT3=0x0f1f0000
ethosu_invoke OPTIMIZER_CONFIG
handle_optimizer_config:
Optimizer release nbr: 0 patch: 1
Optimizer config cmd_stream_version: 0 macs_per_cc: 8 shram_size: 48 custom_dma: 0
Optimizer config Ethos-U version: 1.0.6
Ethos-U config cmd_stream_version: 0 macs_per_cc: 8 shram_size: 48 custom_dma: 0
Ethos-U version: 1.0.6
ethosu_invoke NOP
ethosu_invoke NOP
ethosu_invoke NOP
ethosu_invoke COMMAND_STREAM
handle_command_stream: cmd_stream=0x61025be0, cms_length 1181
QBASE=0x0000000061025be0, QSIZE=4724, base_pointer_offset=0x00000000
BASEP0=0x0000000061026e60
BASEP1=0x0000000060002f10
BASEP2=0x0000000060002f10
BASEP3=0x0000000061000fb0
BASEP4=0x0000000060000fb0
CMD=0x000Interrupt. status=0xffff0022, qread=4724
CMD=0x00000006
00006
CMD=0x0000000c
ethosu_release_driver - Driver 0x20000de8 released
The image has been classified as &#39;tabby&#39;
EXITTHESIM
Info: /OSCI/SystemC: Simulation stopped by user.
</pre></div>
</div>
<p>You should see near the end of the output that the image has been correctly
classified as ‘tabby’.</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-how-to-work-with-microtvm-micro-ethosu-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/ab2eef18d10188532645b1d60fc7dd68/micro_ethosu.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">micro_ethosu.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/55a9eff88b1303e525d53269eeb16897/micro_ethosu.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">micro_ethosu.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</div>
</div>


           </div>
           
          </div>
          

<footer>

    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="micro_pytorch.html" class="btn btn-neutral float-right" title="microTVM PyTorch Tutorial" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="micro_autotune.html" class="btn btn-neutral float-left" title="Autotuning with microTVM" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>

<div id="button" class="backtop"><img src="../../_static/img/right.svg" alt="backtop"/> </div>
<section class="footerSec">
    <div class="footerHeader">
      <div class="d-flex align-md-items-center justify-content-between flex-column flex-md-row">
        <div class="copywrite d-flex align-items-center">
          <h5 id="copy-right-info">© 2022 Apache Software Foundation | All rights reserved</h5>
        </div>
      </div>

    </div>

    <div>
      <div class="footernote">Copyright © 2022 The Apache Software Foundation. Apache TVM, Apache, the Apache feather, and the Apache TVM project logo are either trademarks or registered trademarks of the Apache Software Foundation.</div>
    </div>

</section>
</footer>
        </div>
      </div>

    </section>

  </div>
  

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

  </body>
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-75982049-2', 'auto');
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>